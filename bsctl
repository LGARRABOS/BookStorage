#!/bin/bash
# ============================================================================
# bsctl - BookStorage Control
# ============================================================================
# CLI pour gÃ©rer BookStorage
# Usage: bsctl <commande>
# ============================================================================

set -e

APP_NAME="bookstorage"
APP_VERSION="1.0.0"
APP_USER="nobody"
APP_GROUP="nobody"
INSTALL_DIR="/opt/bookstorage"
BIN_DIR="/usr/local/bin"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ============================================================================
# Fonctions utilitaires
# ============================================================================

print_header() {
    printf "\n"
    printf "${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
    printf "${BOLD}â•‘  ğŸ“š BookStorage Control v${APP_VERSION}        â•‘${NC}\n"
    printf "${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "\n"
}

print_success() {
    printf "${GREEN}âœ“ $1${NC}\n"
}

print_error() {
    printf "${RED}âœ— $1${NC}\n"
}

print_info() {
    printf "${BLUE}â–¶ $1${NC}\n"
}

print_step() {
    printf "${BLUE}[$1]${NC} $2\n"
}

# ============================================================================
# Commandes
# ============================================================================

cmd_help() {
    printf "\n"
    printf "${BOLD}ğŸ“š BookStorage v${APP_VERSION} - Gestionnaire de lectures${NC}\n"
    printf "\n"
    printf "${BOLD}UTILISATION${NC}\n"
    printf "    bsctl ${BLUE}<commande>${NC}\n"
    printf "\n"
    printf "${BOLD}DÃ‰VELOPPEMENT${NC}\n"
    printf "    ${GREEN}build${NC}        Compile l'application\n"
    printf "    ${GREEN}build-prod${NC}   Compile en mode production (optimisÃ©)\n"
    printf "    ${GREEN}run${NC}          Lance le serveur de dÃ©veloppement\n"
    printf "    ${GREEN}clean${NC}        Supprime les fichiers compilÃ©s\n"
    printf "\n"
    printf "${BOLD}PRODUCTION${NC} (nÃ©cessite root)\n"
    printf "    ${GREEN}install${NC}      Installe le service systemd\n"
    printf "    ${GREEN}uninstall${NC}    DÃ©sinstalle le service\n"
    printf "    ${GREEN}update${NC}       Met Ã  jour (git pull + build + restart)\n"
    printf "    ${GREEN}fix-perms${NC}    Corrige les permissions des fichiers\n"
    printf "\n"
    printf "${BOLD}SERVICE${NC}\n"
    printf "    ${GREEN}start${NC}        DÃ©marre le service\n"
    printf "    ${GREEN}stop${NC}         ArrÃªte le service\n"
    printf "    ${GREEN}restart${NC}      RedÃ©marre le service\n"
    printf "    ${GREEN}status${NC}       Affiche le statut du service\n"
    printf "    ${GREEN}logs${NC}         Affiche les logs en temps rÃ©el\n"
    printf "\n"
    printf "${BOLD}EXEMPLES${NC}\n"
    printf "    ${BLUE}bsctl run${NC}              DÃ©veloppement local\n"
    printf "    ${BLUE}sudo bsctl install${NC}     Installer en production\n"
    printf "    ${BLUE}sudo bsctl update${NC}      Mettre Ã  jour le serveur\n"
    printf "    ${BLUE}bsctl logs${NC}             Voir les logs\n"
    printf "\n"
    printf "${BOLD}CONFIGURATION${NC}\n"
    printf "    Variables d'environnement dans ${BLUE}.env${NC} :\n"
    printf "    - BOOKSTORAGE_HOST         (dÃ©faut: 127.0.0.1)\n"
    printf "    - BOOKSTORAGE_PORT         (dÃ©faut: 5000)\n"
    printf "    - BOOKSTORAGE_DATABASE     (dÃ©faut: database.db)\n"
    printf "    - BOOKSTORAGE_SECRET_KEY   (dÃ©faut: dev-secret-change-me)\n"
    printf "\n"
}

cmd_version() {
    printf "BookStorage v${APP_VERSION}\n"
}

cmd_build() {
    print_info "Compilation..."
    go build -o ${APP_NAME} .
    print_success "Compilation terminÃ©e: ./${APP_NAME}"
}

cmd_build_prod() {
    print_info "Compilation production..."
    CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${APP_VERSION}" -o ${APP_NAME} .
    print_success "Binaire optimisÃ© crÃ©Ã©: ./${APP_NAME}"
}

cmd_run() {
    print_info "DÃ©marrage du serveur de dÃ©veloppement..."
    go run .
}

cmd_clean() {
    print_info "Nettoyage..."
    rm -f ${APP_NAME}
    print_success "Nettoyage terminÃ©"
}

cmd_install() {
    print_info "Installation du service ${APP_NAME}..."
    cmd_build_prod
    cp ${APP_NAME} ${BIN_DIR}/
    cp deploy/bookstorage.service /etc/systemd/system/
    systemctl daemon-reload
    systemctl enable ${APP_NAME}
    printf "\n"
    print_success "Service installÃ© avec succÃ¨s"
    printf "\n"
    printf "Commandes disponibles:\n"
    printf "  ${BOLD}bsctl start${NC}   - DÃ©marrer\n"
    printf "  ${BOLD}bsctl stop${NC}    - ArrÃªter\n"
    printf "  ${BOLD}bsctl status${NC}  - Statut\n"
}

cmd_uninstall() {
    print_info "DÃ©sinstallation du service ${APP_NAME}..."
    systemctl stop ${APP_NAME} 2>/dev/null || true
    systemctl disable ${APP_NAME} 2>/dev/null || true
    rm -f /etc/systemd/system/bookstorage.service
    rm -f ${BIN_DIR}/${APP_NAME}
    systemctl daemon-reload
    print_success "Service dÃ©sinstallÃ©"
}

cmd_update() {
    print_header
    
    print_step "1/5" "RÃ©cupÃ©ration des modifications..."
    git pull
    printf "\n"
    
    print_step "2/5" "Compilation..."
    cmd_build_prod
    printf "\n"
    
    print_step "3/5" "Installation du binaire..."
    cp ${APP_NAME} ${BIN_DIR}/
    print_success "Binaire copiÃ©"
    printf "\n"
    
    print_step "4/5" "Correction des permissions..."
    cmd_fix_perms
    printf "\n"
    
    print_step "5/5" "RedÃ©marrage du service..."
    systemctl restart ${APP_NAME}
    print_success "Service redÃ©marrÃ©"
    printf "\n"
    
    printf "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
    printf "${GREEN}â•‘      MISE Ã€ JOUR TERMINÃ‰E âœ“            â•‘${NC}\n"
    printf "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "\n"
    
    systemctl status ${APP_NAME} --no-pager -l | head -15
}

cmd_fix_perms() {
    print_info "Correction des permissions..."
    chown ${APP_USER}:${APP_GROUP} . 2>/dev/null || true
    chmod 755 . 2>/dev/null || true
    chown ${APP_USER}:${APP_GROUP} database.db 2>/dev/null || true
    chmod 664 database.db 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} static/avatars/ 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} static/images/ 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} templates/ 2>/dev/null || true
    print_success "Permissions corrigÃ©es"
}

cmd_start() {
    print_info "DÃ©marrage du service..."
    systemctl start ${APP_NAME}
    print_success "Service dÃ©marrÃ©"
    cmd_status
}

cmd_stop() {
    print_info "ArrÃªt du service..."
    systemctl stop ${APP_NAME}
    print_success "Service arrÃªtÃ©"
}

cmd_restart() {
    print_info "RedÃ©marrage du service..."
    systemctl restart ${APP_NAME}
    print_success "Service redÃ©marrÃ©"
    cmd_status
}

cmd_status() {
    systemctl status ${APP_NAME} --no-pager -l 2>/dev/null || printf "${YELLOW}Service non installÃ©${NC}\n"
}

cmd_logs() {
    print_info "Logs en temps rÃ©el (Ctrl+C pour quitter)..."
    journalctl -u ${APP_NAME} -f
}

# ============================================================================
# Main
# ============================================================================

case "${1:-help}" in
    help|-h|--help)
        cmd_help
        ;;
    version|-v|--version)
        cmd_version
        ;;
    build)
        cmd_build
        ;;
    build-prod)
        cmd_build_prod
        ;;
    run)
        cmd_run
        ;;
    clean)
        cmd_clean
        ;;
    install)
        cmd_install
        ;;
    uninstall)
        cmd_uninstall
        ;;
    update)
        cmd_update
        ;;
    fix-perms)
        cmd_fix_perms
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs
        ;;
    *)
        printf "${RED}Commande inconnue: $1${NC}\n"
        printf "Utilisez ${BOLD}bsctl help${NC} pour voir les commandes disponibles.\n"
        exit 1
        ;;
esac
