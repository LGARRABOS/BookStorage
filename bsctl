#!/bin/bash
# ============================================================================
# bsctl - BookStorage Control
# ============================================================================
# CLI to manage BookStorage
# Usage: bsctl <command>
# ============================================================================

set -e

APP_NAME="bookstorage"
APP_VERSION="1.0.0"
APP_USER="nobody"
APP_GROUP="nobody"
INSTALL_DIR="/opt/bookstorage"
BIN_DIR="/usr/local/bin"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ============================================================================
# Utility functions
# ============================================================================

print_header() {
    printf "\n"
    printf "${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
    printf "${BOLD}â•‘  ğŸ“š BookStorage Control v${APP_VERSION}        â•‘${NC}\n"
    printf "${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "\n"
}

print_success() {
    printf "${GREEN}âœ“ $1${NC}\n"
}

print_error() {
    printf "${RED}âœ— $1${NC}\n"
}

print_info() {
    printf "${BLUE}â–¶ $1${NC}\n"
}

print_step() {
    printf "${BLUE}[$1]${NC} $2\n"
}

# ============================================================================
# Commands
# ============================================================================

cmd_help() {
    printf "\n"
    printf "${BOLD}ğŸ“š BookStorage v${APP_VERSION} - Personal reading tracker${NC}\n"
    printf "\n"
    printf "${BOLD}USAGE${NC}\n"
    printf "    bsctl ${BLUE}<command>${NC}\n"
    printf "\n"
    printf "${BOLD}DEVELOPMENT${NC}\n"
    printf "    ${GREEN}build${NC}        Compile the application\n"
    printf "    ${GREEN}build-prod${NC}   Compile for production (optimized)\n"
    printf "    ${GREEN}run${NC}          Start the development server\n"
    printf "    ${GREEN}clean${NC}        Remove compiled files\n"
    printf "\n"
    printf "${BOLD}PRODUCTION${NC} (requires root)\n"
    printf "    ${GREEN}install${NC}      Install the systemd service\n"
    printf "    ${GREEN}uninstall${NC}    Uninstall the service\n"
    printf "    ${GREEN}update${NC}       Update (git pull + build + restart)\n"
    printf "    ${GREEN}fix-perms${NC}    Fix file permissions\n"
    printf "\n"
    printf "${BOLD}SERVICE${NC}\n"
    printf "    ${GREEN}start${NC}        Start the service\n"
    printf "    ${GREEN}stop${NC}         Stop the service\n"
    printf "    ${GREEN}restart${NC}      Restart the service\n"
    printf "    ${GREEN}status${NC}       Show service status\n"
    printf "    ${GREEN}logs${NC}         Show logs in real-time\n"
    printf "\n"
    printf "${BOLD}EXAMPLES${NC}\n"
    printf "    ${BLUE}bsctl run${NC}              Local development\n"
    printf "    ${BLUE}sudo bsctl install${NC}     Install in production\n"
    printf "    ${BLUE}sudo bsctl update${NC}      Update the server\n"
    printf "    ${BLUE}bsctl logs${NC}             View logs\n"
    printf "\n"
    printf "${BOLD}CONFIGURATION${NC}\n"
    printf "    Environment variables in ${BLUE}.env${NC}:\n"
    printf "    - BOOKSTORAGE_HOST         (default: 127.0.0.1)\n"
    printf "    - BOOKSTORAGE_PORT         (default: 5000)\n"
    printf "    - BOOKSTORAGE_DATABASE     (default: database.db)\n"
    printf "    - BOOKSTORAGE_SECRET_KEY   (default: dev-secret-change-me)\n"
    printf "\n"
}

cmd_version() {
    printf "BookStorage v${APP_VERSION}\n"
}

cmd_build() {
    print_info "Compiling..."
    go build -o ${APP_NAME} .
    print_success "Build complete: ./${APP_NAME}"
}

cmd_build_prod() {
    print_info "Compiling for production..."
    CGO_ENABLED=1 go build -ldflags="-s -w -X main.Version=${APP_VERSION}" -o ${APP_NAME} .
    print_success "Optimized binary created: ./${APP_NAME}"
}

cmd_run() {
    print_info "Starting development server..."
    go run .
}

cmd_clean() {
    print_info "Cleaning up..."
    rm -f ${APP_NAME}
    print_success "Cleanup complete"
}

cmd_install() {
    print_info "Installing ${APP_NAME} service..."
    cmd_build_prod
    cp ${APP_NAME} ${BIN_DIR}/
    cp deploy/bookstorage.service /etc/systemd/system/
    systemctl daemon-reload
    systemctl enable ${APP_NAME}
    printf "\n"
    print_success "Service installed successfully"
    printf "\n"
    printf "Available commands:\n"
    printf "  ${BOLD}bsctl start${NC}   - Start\n"
    printf "  ${BOLD}bsctl stop${NC}    - Stop\n"
    printf "  ${BOLD}bsctl status${NC}  - Status\n"
}

cmd_uninstall() {
    print_info "Uninstalling ${APP_NAME} service..."
    systemctl stop ${APP_NAME} 2>/dev/null || true
    systemctl disable ${APP_NAME} 2>/dev/null || true
    rm -f /etc/systemd/system/bookstorage.service
    rm -f ${BIN_DIR}/${APP_NAME}
    systemctl daemon-reload
    print_success "Service uninstalled"
}

cmd_update() {
    print_header
    
    print_step "1/6" "Fetching updates..."
    git pull
    printf "\n"
    
    print_step "2/6" "Compiling..."
    cmd_build_prod
    printf "\n"
    
    print_step "3/6" "Installing binary..."
    cp ${APP_NAME} ${BIN_DIR}/
    print_success "Binary copied"
    printf "\n"
    
    print_step "4/6" "Updating bsctl script..."
    cp bsctl ${BIN_DIR}/
    chmod +x ${BIN_DIR}/bsctl
    print_success "bsctl updated"
    printf "\n"
    
    print_step "5/6" "Fixing permissions..."
    cmd_fix_perms
    printf "\n"
    
    print_step "6/6" "Restarting service..."
    systemctl restart ${APP_NAME}
    print_success "Service restarted"
    printf "\n"
    
    printf "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
    printf "${GREEN}â•‘         UPDATE COMPLETE âœ“              â•‘${NC}\n"
    printf "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "\n"
    
    systemctl status ${APP_NAME} --no-pager -l | head -15
}

cmd_fix_perms() {
    print_info "Fixing permissions..."
    chown ${APP_USER}:${APP_GROUP} . 2>/dev/null || true
    chmod 755 . 2>/dev/null || true
    chown ${APP_USER}:${APP_GROUP} database.db 2>/dev/null || true
    chmod 664 database.db 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} static/avatars/ 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} static/images/ 2>/dev/null || true
    chown -R ${APP_USER}:${APP_GROUP} templates/ 2>/dev/null || true
    print_success "Permissions fixed"
}

cmd_start() {
    print_info "Starting service..."
    systemctl start ${APP_NAME}
    print_success "Service started"
    cmd_status
}

cmd_stop() {
    print_info "Stopping service..."
    systemctl stop ${APP_NAME}
    print_success "Service stopped"
}

cmd_restart() {
    print_info "Restarting service..."
    systemctl restart ${APP_NAME}
    print_success "Service restarted"
    cmd_status
}

cmd_status() {
    systemctl status ${APP_NAME} --no-pager -l 2>/dev/null || printf "${YELLOW}Service not installed${NC}\n"
}

cmd_logs() {
    print_info "Real-time logs (Ctrl+C to quit)..."
    journalctl -u ${APP_NAME} -f
}

# ============================================================================
# Main
# ============================================================================

case "${1:-help}" in
    help|-h|--help)
        cmd_help
        ;;
    version|-v|--version)
        cmd_version
        ;;
    build)
        cmd_build
        ;;
    build-prod)
        cmd_build_prod
        ;;
    run)
        cmd_run
        ;;
    clean)
        cmd_clean
        ;;
    install)
        cmd_install
        ;;
    uninstall)
        cmd_uninstall
        ;;
    update)
        cmd_update
        ;;
    fix-perms)
        cmd_fix_perms
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs
        ;;
    *)
        printf "${RED}Unknown command: $1${NC}\n"
        printf "Use ${BOLD}bsctl help${NC} to see available commands.\n"
        exit 1
        ;;
esac
