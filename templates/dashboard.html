{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}
{% block custom_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}
{% block content %}
<section class="page-section">
  <header class="section-header">
    <h1>Ma bibliothèque</h1>
    <p>Visualisez vos œuvres suivies, mettez à jour votre progression et accédez rapidement à vos lectures en ligne.</p>
  </header>

  <div class="dashboard-toolbar">
    <a class="btn btn-primary" href="{{ url_for('add_work') }}">Ajouter une nouvelle œuvre</a>
    <div class="toolbar-filters">
      <label class="visually-hidden" for="search-input">Rechercher par titre</label>
      <input type="text" id="search-input" placeholder="Rechercher par titre..." autocomplete="off">

      <label class="visually-hidden" for="status-filter">Filtrer par statut</label>
      <select id="status-filter">
        <option value="">Tous les statuts</option>
        <option value="En cours">En cours</option>
        <option value="Terminé">Terminé</option>
        <option value="En pause">En pause</option>
        <option value="Abandonné">Abandonné</option>
        <option value="À lire">À lire</option>
      </select>
    </div>
  </div>

  <div class="dashboard-shortcuts" role="region" aria-label="Actions rapides">
    <article class="shortcut-card">
      <h2>Gérer mon profil</h2>
      <p>Personnalisez votre identité, mettez à jour vos informations et choisissez la visibilité de votre bibliothèque.</p>
      <a class="btn btn-secondary" href="{{ url_for('profile') }}">Accéder à mon profil</a>
    </article>
    <article class="shortcut-card">
      <h2>Explorer les lecteurs</h2>
      <p>Recherchez les autres membres publics et importez leurs lectures partagées dans votre propre liste.</p>
      <a class="btn btn-secondary" href="{{ url_for('users_directory') }}">Ouvrir l'annuaire</a>
    </article>
  </div>

  {% if works %}
  <div class="table-wrapper library-table">
    <table class="data-table">
      <thead>
        <tr>
          <th>Visuel</th>
          <th>Titre</th>
          <th>Chapitre</th>
          <th>Lien</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for work in works %}
        <tr>
          <td class="cover-cell">
            {% if work.image_path %}
              <img src="{{ url_for('static', filename=work.image_path) }}" alt="Image de {{ work.title }}">
            {% else %}
              <span class="badge info">Pas d'image</span>
            {% endif %}
          </td>
          <td>
            <div class="work-title">{{ work.title }}</div>
          </td>
          <td>
            <span id="chapter-{{ work.id }}" class="chapter-count">{{ work.chapter }}</span>
          </td>
          <td>
            {% if work.link %}
              <a class="external-link" href="{{ work.link }}" target="_blank" rel="noopener">Ouvrir</a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td>
            <span class="badge status-badge" data-status="{{ work.status }}">{{ work.status }}</span>
          </td>
          <td class="actions">
            <div class="action-buttons">
              <button type="button" class="btn btn-icon accent increment-btn" data-work-id="{{ work.id }}" aria-label="Ajouter un chapitre">
                +1
              </button>
              <button type="button" class="btn btn-icon neutral decrement-btn" data-work-id="{{ work.id }}" aria-label="Retirer un chapitre">
                −1
              </button>
              <a class="btn btn-icon danger" href="{{ url_for('delete', work_id=work.id) }}" onclick="return confirm('Supprimer cette œuvre de la bibliothèque ?');">Supprimer</a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="empty-state">
      <h2>Votre bibliothèque est prête</h2>
      <p>Ajoutez votre première œuvre pour commencer à suivre vos lectures et chapitres préférés.</p>
      <a class="btn btn-primary" href="{{ url_for('add_work') }}">Ajouter une œuvre</a>
    </div>
  {% endif %}
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Gestion des boutons d'incrémentation
  document.querySelectorAll(".increment-btn").forEach(function(button) {
    button.addEventListener("click", function(event) {
      event.preventDefault();
      const workId = this.getAttribute("data-work-id");
      fetch(`/api/increment/${workId}`, { method: "POST" })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`chapter-${workId}`).innerText = data.chapter;
          }
        })
        .catch(error => console.error("Erreur :", error));
    });
  });
  // Gestion des boutons de décrémentation
  document.querySelectorAll(".decrement-btn").forEach(function(button) {
    button.addEventListener("click", function(event) {
      event.preventDefault();
      const workId = this.getAttribute("data-work-id");
      fetch(`/api/decrement/${workId}`, { method: "POST" })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`chapter-${workId}`).innerText = data.chapter;
          }
        })
        .catch(error => console.error("Erreur :", error));
    });
  });

  // Barre de recherche et filtre par statut
  const searchInput = document.getElementById("search-input");
  const statusFilter = document.getElementById("status-filter");
  const tableRows = document.querySelectorAll(".library-table tbody tr");

  function filterTable() {
    const searchValue = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    tableRows.forEach(function(row) {
      const title = row.querySelector(".work-title").innerText.toLowerCase();
      const status = row.querySelector(".badge").innerText.trim();
      const matchesSearch = title.includes(searchValue);
      const matchesStatus = (statusValue === "" || status === statusValue);
      row.style.display = (matchesSearch && matchesStatus) ? "" : "none";
    });
  }

  searchInput.addEventListener("input", filterTable);
  statusFilter.addEventListener("change", filterTable);
});
</script>
{% endblock %}
